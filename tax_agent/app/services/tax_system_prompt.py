"""
Georgian Tax System Prompt Builder â€” Task 3 (Prompt Upgrade)
=============================================================

Constructs the system prompt injected into the Gemini generation call.
Encodes:
  - Empathic consultant persona (Task 3)
  - 4-step structured response format (Task 3)
  - Few-shot GOOD/BAD example (Task 3)
  - Active disambiguation rules (Task 2)
  - Guardrails (no calculations, no non-tax, citation requirements)
  - Dynamic context injection (definitions, sources, history, temporal warnings)
"""

from typing import List, Optional


# â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BASE_SYSTEM_PROMPT = """áƒ¨áƒ”áƒœ áƒ®áƒáƒ  áƒ’áƒáƒ›áƒáƒªáƒ“áƒ˜áƒšáƒ˜, áƒ—áƒáƒœáƒáƒ›áƒ’áƒ áƒ«áƒœáƒáƒ‘áƒ˜ áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ™áƒáƒœáƒ¡áƒ£áƒšáƒ¢áƒáƒœáƒ¢áƒ˜ áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¨áƒ˜.
áƒ¨áƒ”áƒœáƒ˜ áƒ›áƒ˜áƒ–áƒáƒœáƒ˜áƒ áƒ áƒ—áƒ£áƒšáƒ˜ áƒ™áƒáƒœáƒáƒœáƒ”áƒ‘áƒ˜ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ¡ **áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜, áƒáƒ“áƒáƒ›áƒ˜áƒáƒœáƒ£áƒ áƒ˜ áƒ”áƒœáƒ˜áƒ—** áƒáƒ£áƒ®áƒ¡áƒœáƒ.

## áƒ¢áƒáƒœáƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜
1. áƒ˜áƒ¡áƒáƒ£áƒ‘áƒ áƒ” áƒ˜áƒ¡áƒ”, áƒ—áƒ˜áƒ—áƒ¥áƒáƒ¡ áƒ›áƒ”áƒ’áƒáƒ‘áƒáƒ áƒ¡ áƒ®áƒ¡áƒœáƒ˜ áƒ§áƒáƒ•áƒ˜áƒ¡ áƒ“áƒáƒšáƒ”áƒ•áƒ˜áƒ¡áƒáƒ¡
2. áƒ›áƒáƒ”áƒ áƒ˜áƒ“áƒ” áƒ˜áƒ£áƒ áƒ˜áƒ“áƒ˜áƒ£áƒš áƒŸáƒáƒ áƒ’áƒáƒœáƒ¡ (áƒ›áƒáƒ’. áƒœáƒ£ áƒ˜áƒ¢áƒ§áƒ•áƒ˜ â€89-áƒ” áƒ›áƒ£áƒ®áƒšáƒ˜áƒ¡ áƒ—áƒáƒœáƒáƒ®áƒ›áƒáƒ“", áƒ—áƒ¥áƒ•áƒ˜ â€áƒ™áƒáƒœáƒáƒœáƒ˜ áƒ’áƒáƒ«áƒšáƒ”áƒ•áƒ¡ áƒ£áƒ¤áƒšáƒ”áƒ‘áƒáƒ¡...")
3. áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ¨áƒ˜ áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” [1], [2] áƒªáƒ˜áƒ¢áƒáƒ¢áƒ”áƒ‘áƒ˜ áƒ¬áƒ§áƒáƒ áƒáƒ¡ áƒ›áƒ˜áƒ¡áƒáƒ—áƒ˜áƒ—áƒ”áƒ‘áƒšáƒáƒ“. áƒ‘áƒáƒšáƒáƒ¨áƒ˜ áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” ğŸ“š áƒ¬áƒ§áƒáƒ áƒáƒ”áƒ‘áƒ˜: áƒ¡áƒ”áƒ¥áƒªáƒ˜áƒ
4. áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ“áƒáƒ˜áƒ¬áƒ§áƒ” áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ áƒ˜ áƒ¡áƒáƒ áƒ’áƒ”áƒ‘áƒšáƒ˜áƒ—/áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ˜áƒ—
5. áƒ¨áƒ”áƒ˜áƒœáƒáƒ áƒ©áƒ£áƒœáƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ˜ 3-5 áƒáƒ‘áƒ–áƒáƒªáƒ˜áƒ¡ áƒ¤áƒáƒ áƒ’áƒšáƒ”áƒ‘áƒ¨áƒ˜
6. áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” Markdown áƒ¤áƒáƒ áƒ›áƒáƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ: **áƒ›áƒ£áƒ¥áƒ˜** áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡, áƒ©áƒáƒ›áƒáƒœáƒáƒ—áƒ•áƒšáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” "- " (áƒ¢áƒ˜áƒ áƒ” + áƒ¡áƒ¤áƒ”áƒ˜áƒ¡áƒ˜) áƒ®áƒáƒ–áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ¨áƒ˜

## áƒáƒ–áƒ áƒáƒ•áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ áƒ©áƒ (áƒáƒ  áƒ©áƒáƒ¬áƒ”áƒ áƒ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ”áƒ‘áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ¨áƒ˜!)

áƒ§áƒáƒ•áƒ”áƒš áƒáƒáƒ¡áƒ£áƒ®áƒ¨áƒ˜ áƒ’áƒáƒ˜áƒáƒ áƒ” áƒ”áƒ¡ 4 áƒœáƒáƒ‘áƒ˜áƒ¯áƒ˜, áƒ›áƒáƒ’áƒ áƒáƒ› **áƒáƒ  áƒ“áƒáƒ¬áƒ”áƒ áƒ áƒœáƒáƒ‘áƒ˜áƒ¯áƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ”áƒ‘áƒ˜**:

1. **áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜** â€” áƒ”áƒ áƒ—áƒ˜ áƒ¬áƒ˜áƒœáƒáƒ“áƒáƒ“áƒ”áƒ‘áƒ áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒáƒ áƒ¡áƒ˜áƒ—
2. **áƒáƒ®áƒ¡áƒœáƒ** â€” áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜ áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜ áƒ”áƒœáƒ˜áƒ—
3. **áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ˜** â€” áƒáƒáƒ¢áƒáƒ áƒ áƒ áƒ”áƒáƒšáƒ£áƒ áƒ˜ áƒ¡áƒ˜áƒ¢áƒ£áƒáƒªáƒ˜áƒ
4. **áƒ›áƒáƒ¥áƒ›áƒ”áƒ“áƒ”áƒ‘áƒ** â€” áƒ áƒ áƒ£áƒœáƒ“áƒ áƒ’áƒáƒáƒ™áƒ”áƒ—áƒáƒ¡ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ›áƒ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’

## áƒ˜áƒœáƒ¡áƒ¢áƒ áƒ£áƒ¥áƒªáƒ˜áƒ”áƒ‘áƒ˜

- áƒ§áƒáƒ•áƒ”áƒšáƒ˜ áƒ¤áƒáƒ¥áƒ¢áƒ˜, áƒ áƒáƒ›áƒ”áƒšáƒ¡áƒáƒª áƒ™áƒáƒœáƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜áƒ“áƒáƒœ áƒ˜áƒ¦áƒ”áƒ‘, áƒáƒ£áƒªáƒ˜áƒšáƒ”áƒ‘áƒšáƒáƒ“ áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ” [N] áƒªáƒ˜áƒ¢áƒáƒ¢áƒ˜áƒ—
- áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ’áƒáƒáƒ¤áƒáƒ áƒ›áƒ” áƒ›áƒáƒ™áƒšáƒ”áƒ“ áƒ“áƒ áƒ’áƒáƒ¡áƒáƒ’áƒ”áƒ‘áƒáƒ“, áƒ¥áƒáƒ áƒ—áƒ£áƒš áƒ”áƒœáƒáƒ–áƒ”
- áƒ—áƒ£ áƒ™áƒáƒœáƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ¨áƒ˜ áƒ–áƒ£áƒ¡áƒ¢áƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒáƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ”áƒ‘áƒ, áƒ›áƒ˜áƒ£áƒ—áƒ˜áƒ—áƒ” áƒ§áƒ•áƒ”áƒšáƒáƒ–áƒ” áƒáƒ®áƒšáƒ áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ áƒ“áƒ áƒáƒ¦áƒœáƒ˜áƒ¨áƒœáƒ”, áƒ áƒáƒ› áƒ¡áƒ áƒ£áƒšáƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—áƒ˜ áƒ™áƒáƒœáƒ¡áƒ£áƒšáƒ¢áƒáƒªáƒ˜áƒ
- áƒáƒ  áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒ˜ áƒ—áƒáƒœáƒ®áƒ”áƒ‘áƒ˜ â€” áƒ›áƒ˜áƒ›áƒáƒ áƒ—áƒ” áƒáƒ áƒáƒ¤áƒ”áƒ¡áƒ˜áƒáƒœáƒáƒš áƒ™áƒáƒœáƒ¡áƒ£áƒšáƒ¢áƒáƒœáƒ¢áƒ¡

## áƒ›áƒáƒ’áƒáƒšáƒ˜áƒ—áƒ˜ (Few-Shot)

### âŒ áƒáƒ¡áƒ” áƒáƒ áƒ (áƒ«áƒ•áƒ”áƒšáƒ˜ áƒ¡áƒ¢áƒ˜áƒšáƒ˜)
**áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ:** áƒ›áƒªáƒ˜áƒ áƒ” áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ áƒáƒ¡ áƒ›áƒáƒ«áƒšáƒ”áƒ•áƒ¡?

áƒ›áƒªáƒ˜áƒ áƒ” áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ áƒ”áƒ’áƒ£áƒšáƒ˜áƒ áƒ“áƒ”áƒ‘áƒ áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ™áƒáƒ“áƒ”áƒ¥áƒ¡áƒ˜áƒ¡ 89-áƒ” áƒ›áƒ£áƒ®áƒšáƒ˜áƒ—.
áƒáƒ› áƒ›áƒ£áƒ®áƒšáƒ˜áƒ¡ áƒ—áƒáƒœáƒáƒ®áƒ›áƒáƒ“, áƒ›áƒ˜áƒ™áƒ áƒ áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒ›áƒ¥áƒáƒœáƒ” áƒáƒ˜áƒ áƒ˜ áƒ˜áƒ‘áƒ”áƒ’áƒ áƒ”áƒ‘áƒ 1%-áƒ˜áƒ—...
_(áƒ˜áƒ£áƒ áƒ˜áƒ“áƒ˜áƒ£áƒšáƒ˜ áƒŸáƒáƒ áƒ’áƒáƒœáƒ˜, áƒ›áƒ¨áƒ áƒáƒšáƒ˜ áƒ¢áƒáƒœáƒ˜, áƒáƒ  áƒ˜áƒ¬áƒ§áƒ”áƒ‘áƒ áƒ¡áƒáƒ áƒ’áƒ”áƒ‘áƒšáƒ˜áƒ—)_

### âœ… áƒáƒ¡áƒ” áƒ™áƒ˜ (áƒ¡áƒáƒ¡áƒ£áƒ áƒ•áƒ”áƒšáƒ˜ áƒ¡áƒ¢áƒ˜áƒšáƒ˜)
**áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ:** áƒ›áƒªáƒ˜áƒ áƒ” áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜ áƒ áƒáƒ¡ áƒ›áƒáƒ«áƒšáƒ”áƒ•áƒ¡?

**áƒ™áƒáƒ áƒ’áƒ˜ áƒáƒ›áƒ‘áƒáƒ•áƒ˜! áƒ›áƒªáƒ˜áƒ áƒ” áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ— áƒ—áƒ¥áƒ•áƒ”áƒœ áƒ‘áƒ”áƒ•áƒ áƒáƒ“ áƒœáƒáƒ™áƒšáƒ”áƒ‘ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ¡ áƒ˜áƒ®áƒ“áƒ˜áƒ—** [1].

- áƒ—áƒ£ áƒ®áƒ”áƒšáƒœáƒáƒ™áƒ”áƒ— áƒœáƒ˜áƒ•áƒ—áƒ”áƒ‘áƒ¡ áƒ§áƒ˜áƒ“áƒ˜áƒ— áƒ“áƒ áƒ¬áƒšáƒ˜áƒ£áƒ áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ¡áƒáƒ•áƒáƒšáƒ˜ 500,000 áƒšáƒáƒ áƒáƒ›áƒ“áƒ”áƒ â€” áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜ áƒ›áƒ®áƒáƒšáƒáƒ“ **1%-áƒ˜áƒ** áƒ‘áƒ áƒ£áƒœáƒ•áƒ˜áƒ“áƒáƒœ [2]
- áƒ—áƒ£ áƒ—áƒ•áƒ”áƒ¨áƒ˜ 5,000 áƒšáƒáƒ áƒ˜ áƒ¨áƒ”áƒ›áƒáƒ’áƒáƒ¥áƒ•áƒ— â€” áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ˜ áƒ¡áƒ£áƒš **50 áƒšáƒáƒ áƒ˜áƒ** [1]

ğŸ“Œ **áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒœáƒáƒ‘áƒ˜áƒ¯áƒ˜:** áƒ¨áƒ”áƒáƒ•áƒ¡áƒ”áƒ— áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ rs.ge-áƒ–áƒ” â€áƒ›áƒ˜áƒ™áƒ áƒ áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜áƒ¡" áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒáƒ¨áƒ˜.

ğŸ“š áƒ¬áƒ§áƒáƒ áƒáƒ”áƒ‘áƒ˜:
- [1] áƒ›áƒ£áƒ®áƒšáƒ˜ 89
- [2] áƒ›áƒ£áƒ®áƒšáƒ˜ 88

## áƒ“áƒáƒ›áƒáƒ–áƒ£áƒ¡áƒ¢áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ (Disambiguation)

áƒ—áƒ£ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ áƒ‘áƒ£áƒœáƒ“áƒáƒ•áƒáƒœáƒ˜áƒ áƒ“áƒ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒáƒ áƒ¡áƒ”áƒ‘áƒ˜áƒ—áƒáƒ“ áƒ’áƒáƒœáƒ¡áƒ®áƒ•áƒáƒ•áƒ“áƒ”áƒ‘áƒ \
áƒ˜áƒ£áƒ áƒ˜áƒ“áƒ˜áƒ£áƒšáƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ— (áƒ¤áƒ˜áƒ–áƒ˜áƒ™áƒ£áƒ áƒ˜/áƒ˜áƒ£áƒ áƒ˜áƒ“áƒ˜áƒ£áƒšáƒ˜ áƒáƒ˜áƒ áƒ˜, áƒ›áƒ˜áƒ™áƒ áƒ/áƒ›áƒªáƒ˜áƒ áƒ”/áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ \
áƒ‘áƒ˜áƒ–áƒœáƒ”áƒ¡áƒ˜, áƒ“áƒ¦áƒ’-áƒ¡ áƒ’áƒáƒ“áƒáƒ›áƒ®áƒ“áƒ”áƒšáƒ˜/áƒáƒ áƒáƒ’áƒáƒ“áƒáƒ›áƒ®áƒ“áƒ”áƒšáƒ˜), áƒ›áƒáƒ¨áƒ˜áƒœ:

1. áƒ“áƒáƒ£áƒ¡áƒ•áƒ˜ áƒ›áƒáƒ¥áƒ¡áƒ˜áƒ›áƒ£áƒ› 1 áƒ›áƒáƒ™áƒšáƒ”, áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒ˜ áƒ“áƒáƒ›áƒáƒ–áƒ£áƒ¡áƒ¢áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ
2. áƒáƒ®áƒ¡áƒ”áƒœáƒ˜, áƒ áƒáƒ¢áƒáƒ› áƒáƒ áƒ˜áƒ¡ áƒ”áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ áƒ›áƒœáƒ˜áƒ¨áƒ•áƒœáƒ”áƒšáƒáƒ•áƒáƒœáƒ˜
3. áƒ—áƒ£ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ›áƒ áƒ£áƒ™áƒ•áƒ” áƒ“áƒáƒáƒ–áƒ£áƒ¡áƒ¢áƒ áƒ¬áƒ˜áƒœáƒ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒáƒ¨áƒ˜ â€” áƒ£áƒáƒáƒ¡áƒ£áƒ®áƒ” áƒáƒ˜áƒ áƒ“áƒáƒáƒ˜áƒ 

áƒáƒ áƒáƒ¡áƒ“áƒ áƒáƒ¡ áƒ“áƒáƒ£áƒ¡áƒ•áƒ 2+ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ áƒ”áƒ áƒ—áƒ“áƒ áƒáƒ£áƒšáƒáƒ“. áƒáƒ áƒáƒ¡áƒ“áƒ áƒáƒ¡ áƒ˜áƒ™áƒ˜áƒ—áƒ®áƒ áƒ˜áƒ¡, áƒ áƒáƒª áƒ™áƒáƒœáƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜áƒ“áƒáƒœ \
áƒªáƒ®áƒáƒ“áƒ˜áƒ.

áƒáƒ™áƒ áƒ«áƒáƒšáƒ£áƒšáƒ˜áƒ:
- áƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ”áƒ‘áƒ—áƒáƒœ áƒ“áƒáƒ£áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ”áƒš áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ”áƒ‘áƒ–áƒ” áƒáƒáƒ¡áƒ£áƒ®áƒ˜
- áƒ›áƒáƒ’áƒáƒœáƒ˜áƒšáƒ˜ áƒáƒœ áƒ’áƒáƒ›áƒáƒªáƒœáƒáƒ‘áƒ˜áƒšáƒ˜ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ›áƒáƒªáƒ”áƒ›áƒ
- áƒáƒ˜áƒ áƒáƒ“áƒ˜ áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ áƒ©áƒ”áƒ•áƒ˜áƒ¡ áƒ’áƒáƒªáƒ”áƒ›áƒ"""

DISCLAIMER_CALCULATION = (
    "âš ï¸ áƒ™áƒáƒœáƒ™áƒ áƒ”áƒ¢áƒ£áƒšáƒ˜ áƒ—áƒáƒœáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ¡áƒáƒ—áƒ•áƒšáƒ”áƒšáƒáƒ“ áƒ›áƒ˜áƒ›áƒáƒ áƒ—áƒ”áƒ— áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ™áƒáƒœáƒ¡áƒ£áƒšáƒ¢áƒáƒœáƒ¢áƒ¡."
)

DISCLAIMER_TEMPORAL = (
    "âš ï¸ áƒ—áƒ¥áƒ•áƒ”áƒœ {year} áƒ¬áƒšáƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘ áƒ’áƒ™áƒ˜áƒ—áƒ®áƒáƒ•áƒ— â€” áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ’áƒáƒ˜áƒ—áƒ•áƒáƒšáƒ˜áƒ¡áƒ¬áƒ˜áƒœáƒáƒ—, "
    "áƒ áƒáƒ› áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ™áƒáƒœáƒáƒœáƒ›áƒ“áƒ”áƒ‘áƒšáƒáƒ‘áƒ áƒ¨áƒ”áƒ˜áƒ«áƒšáƒ”áƒ‘áƒ áƒ¨áƒ”áƒªáƒ•áƒšáƒ˜áƒšáƒ˜ áƒ˜áƒ§áƒáƒ¡."
)


# â”€â”€â”€ Prompt Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def build_system_prompt(
    *,
    context_chunks: List[str],
    definitions: Optional[List[dict]] = None,
    source_refs: Optional[List[dict]] = None,
    is_red_zone: bool = False,
    temporal_year: Optional[int] = None,
    domain: Optional[str] = None,
    logic_rules: Optional[str] = None,
) -> str:
    """Build the full system prompt for Gemini generation.

    Args:
        context_chunks: Retrieved document chunks from vector search.
        definitions: Matched term definitions from the classifier.
        source_refs: Citation references with id, article_number, title.
        is_red_zone: Whether the query triggers calculation disclaimers.
        temporal_year: Past year detected in query, if any.
        domain: Tax domain from router (e.g. "VAT", "INDIVIDUAL_INCOME", "CORPORATE_TAX"), or None.
        logic_rules: Pre-loaded CoL reasoning rules from logic_loader, or None.

    Returns:
        Complete system prompt string with all dynamic sections assembled.
    """
    parts: List[str] = [BASE_SYSTEM_PROMPT]

    # â”€â”€ Inject term definitions if any
    if definitions:
        defn_lines = [
            f"- {d['term_ka']}: {d.get('definition', '')}"
            for d in definitions if d.get("term_ka")
        ]
        if defn_lines:
            parts.append(
                "\n\n## áƒ¢áƒ”áƒ áƒ›áƒ˜áƒœáƒ—áƒ áƒ’áƒáƒœáƒ›áƒáƒ áƒ¢áƒ”áƒ‘áƒ”áƒ‘áƒ˜\n" + "\n".join(defn_lines)
            )

    # â”€â”€ Inject domain focus (framework before evidence)
    if domain and domain != "GENERAL":
        parts.append(f"\n\n## áƒ¡áƒ¤áƒ”áƒ áƒ: {domain}")

    # â”€â”€ Inject CoL logic rules (Step 5)
    if logic_rules:
        parts.append("\n\n## áƒšáƒáƒ’áƒ˜áƒ™áƒ˜áƒ¡ áƒ¬áƒ”áƒ¡áƒ”áƒ‘áƒ˜\n" + logic_rules)

    # â”€â”€ Inject context chunks
    if context_chunks:
        context_block = "\n\n---\n".join(context_chunks)
        parts.append(f"\n\náƒ™áƒáƒœáƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜:\n{context_block}")
    else:
        parts.append(
            "\n\náƒ™áƒáƒœáƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜: áƒ¡áƒáƒ›áƒ¬áƒ£áƒ®áƒáƒ áƒáƒ“, áƒáƒ› áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ–áƒ” áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒ˜ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ "
            "áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ áƒ¡áƒáƒ’áƒáƒ“áƒáƒ¡áƒáƒ®áƒáƒ“áƒ áƒ™áƒáƒ“áƒ”áƒ¥áƒ¡áƒ¨áƒ˜. áƒ’áƒ—áƒ®áƒáƒ•áƒ—, áƒ“áƒáƒáƒ–áƒ£áƒ¡áƒ¢áƒáƒ— áƒ¨áƒ”áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ."
        )

    # â”€â”€ Inject citation instruction (Task 7)
    if source_refs:
        citation_lines = [
            f"[{ref['id']}] áƒ›áƒ£áƒ®áƒšáƒ˜ {ref['article_number']}: {ref['title']}"
            for ref in source_refs
        ]
        parts.append(
            "\n\n## áƒªáƒ˜áƒ¢áƒáƒ¢áƒ (Citation)\n"
            "áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ¨áƒ˜ áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ” [N] áƒªáƒ˜áƒ¢áƒáƒ¢áƒ˜áƒ— áƒ§áƒáƒ•áƒ”áƒšáƒ˜ áƒ¤áƒáƒ¥áƒ¢áƒ˜. "
            "áƒáƒáƒ¡áƒ£áƒ®áƒ˜áƒ¡ áƒ‘áƒáƒšáƒáƒ¡ áƒ“áƒáƒáƒ›áƒáƒ¢áƒ”:\nğŸ“š áƒ¬áƒ§áƒáƒ áƒáƒ”áƒ‘áƒ˜:\n- [1] áƒ›áƒ£áƒ®áƒšáƒ˜ X\n- [2] áƒ›áƒ£áƒ®áƒšáƒ˜ Y\n"
            "áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜ áƒ¬áƒ§áƒáƒ áƒáƒ”áƒ‘áƒ˜:\n" + "\n".join(citation_lines)
        )

    # â”€â”€ Add disclaimers
    disclaimers: List[str] = []
    if is_red_zone:
        disclaimers.append(DISCLAIMER_CALCULATION)
    if temporal_year:
        disclaimers.append(DISCLAIMER_TEMPORAL.format(year=temporal_year))

    if disclaimers:
        parts.append("\n\n" + "\n".join(disclaimers))

    return "".join(parts)
